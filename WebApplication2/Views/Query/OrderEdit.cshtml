@model WebApplication2.ModelViews.QueryModelByView

@{
    ViewBag.Title = "訂單編輯";

    List<SelectListItem> list = new List<SelectListItem>() { new SelectListItem() { Text = "--請選擇--", Value = "0" } };
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="card shadow">
        <div class="card-header py-3">
            <h3>訂單編輯</h3>
        </div>
        <div class="card-body">
            <div class="form-horizontal">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                @Html.HiddenFor(model => model.Order.OrderID)
                @Html.HiddenFor(model => model.Order.WineryID)
                <div class="form-group row">
                    <div class="col-sm-1">
                        @Html.LabelFor(model => model.Order.WineryID, "酒莊", htmlAttributes: new { @class = "control-label" })
                    </div>
                    <div class="col-sm-3">
                        @Html.TextBoxFor(model => model.Order.Winery.WineryName, htmlAttributes: new { @class = "form-control", @ReadOnly = "true", @autocomplete = "off" })
                        @Html.ValidationMessageFor(model => model.Order.WineryID, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-1">
                        訂購時間：
                    </div>
                    <div class="col-sm-3">
                        <input class="form-control text-box single-line" autocomplete="off" required data-val="true" data-val-date="訂購時間欄位必須是日期。" data-val-required="OrderDate 欄位是必要項。" id="Order_OrderDate" name="Order.OrderDate" type="datetime" value="@Model.Order.OrderDate.ToShortDateString()">
                        @Html.ValidationMessageFor(model => model.Order.OrderDate, "", new { @class = "text-danger" })
                    </div>
                    
                </div>
                <div class="form-group row">
                    <div class="col-sm-1">
                        客戶名稱：
                    </div>
                    <div class="col-sm-3">
                        @Html.EditorFor(model => model.Order.CustomerName, new { htmlAttributes = new { @class = "form-control", @autocomplete = "off", @required = "required" } })
                        @Html.ValidationMessageFor(model => model.Order.CustomerName, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-1">
                        出貨時間：
                    </div>
                    <div class="col-sm-3">
                        <input class="form-control text-box single-line" autocomplete="off" required data-val="true" data-val-date="出貨時間欄位必須是日期。" data-val-required="RequiredDate 欄位是必要項。" id="Order_RequiredDate" name="Order.RequiredDate" type="datetime" value="@Model.Order.RequiredDate.ToShortDateString()">
                        @Html.ValidationMessageFor(model => model.Order.RequiredDate, "", new { @class = "text-danger" })
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-sm-1">
                        @Html.LabelFor(model => model.Order.CustomerPhone, "電話", htmlAttributes: new { @class = "control-label" })
                    </div>
                    <div class="col-sm-3">
                        @Html.EditorFor(model => model.Order.CustomerPhone, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.Order.CustomerPhone, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-1">
                        送達時間：
                    </div>
                    <div class="col-sm-3">
                        @if (Model.Order.ShippedDate == null)
                        {
                            <input class="form-control text-box single-line" autocomplete="off" data-val="true" data-val-date="送達時間欄位必須是日期。" id="Order_ShippedDate" name="Order.ShippedDate" type="datetime" value="">
                        }
                        else
                        {
                            <input class="form-control text-box single-line" autocomplete="off" data-val="true" data-val-date="送達時間欄位必須是日期。" id="Order_ShippedDate" name="Order.ShippedDate" type="datetime" value="@Model.Order.ShippedDate.Value.ToShortDateString()">
                        }
                        @Html.ValidationMessageFor(model => model.Order.ShippedDate, "", new { @class = "text-danger" })
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-sm-1">
                        @Html.LabelFor(model => model.Order.CustomerAddress, "地址", htmlAttributes: new { @class = "control-label" })
                    </div>
                    <div class="col-sm-8">
                        @Html.EditorFor(model => model.Order.CustomerAddress, new { htmlAttributes = new { @class = "form-control", @autocomplete = "off" } })
                        @Html.ValidationMessageFor(model => model.Order.CustomerAddress, "", new { @class = "text-danger" })
                    </div>
                    <div class="col-sm-1"></div>
                </div>
                <div class="form-group row">
                    <div class="col-sm-1">
                        備註：
                    </div>
                    <div class="col-sm-8">
                        @Html.EditorFor(model => model.Order.Note, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.Order.Note, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-md-offset-2 col-md-10">
                        <button type="submit" class="btn btn-warning"><span class="fa fa-save"></span>&nbsp;儲存</button>
                        <a href="@Url.Action("OrderQuery")" class="btn btn-info"><span class='fa fa-undo'></span>&nbsp;回查詢頁面</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<br />
<div class="card shadow">
    <div class="card-body">
        <table id="OrderEditTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>
                        產品編號
                    </th>
                    <th>
                        產品名稱
                    </th>
                    <th>
                        訂購數量
                    </th>
                    <th class="text-center">
                        <button id="Btn_Add" class="btn btn-primary"><span class="fa fa-plus"></span>&nbsp;新增</button>
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Order_details != null)
                {
                    int count = 0;
                    foreach (var item in Model.Order_details)
                    {

                        <tr id="@count" data-item="@item.OrderID,@item.ProductID,@item.Quantity">
                            <td id="productid">
                                @Html.DisplayFor(modelitem => item.ProductID)
                            </td>
                            <td id="productname">
                                @Html.DisplayFor(modelitem => item.Product.ProductName)
                            </td>
                            <td id="quantity">
                                @Html.DisplayFor(modelitem => item.Quantity)
                            </td>
                            <td class="text-center">
                                <button id="btnEdit" data-count="@count" data-Orderid="@item.OrderID" data-Prodcutid="@item.ProductID" class="btn btn-success"><span class="fa fa-edit"></span>&nbsp;編輯</button>
                                <button id="btnDelete" data-count="@count" class="btn btn-danger"><span class="fa fa-trash"></span>&nbsp;刪除</button>
                            </td>
                            @{count++;}
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>
<br />

<div class="modal fade" id="EditModal" tabindex="-1" role="dialog" aria-labelledby="EditModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="EditModalTitle"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <div class="col-sm-3">
                        產品名稱
                    </div>
                    <div class="col-sm-6">
                        <select id="Dlog_ProductName" name="Dlog_ProductName" class="form-control"></select>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-sm-3">
                        訂購數量
                    </div>
                    <div class="col-sm-6">
                        @Html.TextBox("Dlog_Quantity", "", htmlAttributes: new { @class = "form-control" })
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <button id="Btn_Sava" class="btn btn-warning"><span class="fa fa-save"></span>&nbsp;儲存</button>
                        <button id="Btn_Not" class="btn btn-danger"><span class="fa fa-times"></span>&nbsp;取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>

    function ProductData() {
        $.post("@Url.Action("GetProduct", "Query")", { 'id': null}, function (datas) {
            $.each(datas, function (Idx, data) {
                var op = $('<option></option>');
                op.text(data.ProductName);
                op.val(data.ProductID);
                $('#Dlog_ProductName').append(op);
            })
        })
    }

        function WineryData() {
            $.getJSON("@Url.Action("GetWinery","Query")", function (datas) {
                $.each(datas, function (Idx, data) {
                    var op = $('<option></option>');
                    op.text(data.WineryName);
                    op.val(data.WineryID);
                    $('#DDL_Winery').append(op);
                })
                $('#DDL_Winery option[value=@Model.Order.WineryID]').attr('selected', true);
            })
        }

    $.datepicker.regional['zh-TW'] = {
        dayNames: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
        dayNamesMin: ["日", "一", "二", "三", "四", "五", "六"],
        monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        monthNamesShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        prevText: "上月",
        nextText: "次月",
        weekHeader: "週"
    };
    //將預設語系設定為中文
    $.datepicker.setDefaults($.datepicker.regional["zh-TW"]);

        $(function () {
            WineryData();
            ProductData();
            $('#Order_OrderDate').datepicker({ dateFormat: "yy/mm/dd" });
            $('#Order_ShippedDate').datepicker({ dateFormat: "yy/mm/dd" });
            $('#Order_RequiredDate').datepicker({ dateFormat: "yy/mm/dd" });

            $('[id="btnEdit"]').on('click', function () {
                $('#EditModal').modal("show");
                $('#EditModalTitle').text("訂單內容編輯");
                var orderid = $(this).attr('data-Orderid');
                var productid = $(this).attr('data-Prodcutid');
                var tid = $(this).attr('data-count');
                var titem = $('#'+tid).attr('data-item');
                $.post("@Url.Action("Dialog_OrderDetail","Query")",
                    { 'id': orderid, 'pid': productid },
                    function (datas) {
                        $('#Dlog_ProductName').val(datas[0].ProductID);
                        $('#Dlog_Quantity').val(datas[0].Quantity);
                        $('#Btn_Sava').attr('data-model', 'Edit');
                        $('#Btn_Sava').attr('data-td', titem);
                    })
            });

            $('[id="Btn_Sava"]').on('click', function () {
                let model = $(this).attr('data-model');
                var oid ='@Model.Order.OrderID';
                var pid = $('#Dlog_ProductName :selected').val();
                var qty = $('#Dlog_Quantity').val();
                var tdid = $(this).attr('data-td');
                if (qty == null || qty=="") {
                    alert("數量不可為空白");
                }
                else if (confirm("確認送出？")) {
                    Dodialog(model, oid, pid, qty, tdid);
                }
            });

            function Dodialog(model, oid, pid, qty, tdid) {
                if (model == 'Insert') {
                    $.post("@Url.Action("Order_DetailInsert","Query")", { 'oid': oid, 'pid': pid, 'qty': qty },
                        function (datas) {
                            if (datas != "0") {
                                alert(datas);
                            }
                            $('#EditModal').modal("hide");
                            location.reload();
                        })
                }
                else if (model == 'Edit') {
                    $.post("@Url.Action("Order_DetailEdit","Query")", { 'item': tdid, 'oid': oid, 'pid': pid, 'qty': qty },
                        function (datas) {
                            if (datas != "0") {
                                alert(datas);
                            }
                            $('#EditModal').modal("hide");
                            location.reload();
                        })
                }
            }

            $('[id="Btn_Add"]').on('click', function () {
                $('#Dlog_ProductName option[value=1]').attr('selected', true);
                $('#Dlog_Quantity').val("");
                $('#Dlog_Quantity').text("");
                $('#Btn_Sava').attr('data-model', 'Insert');
                $('#EditModalTitle').text("訂單內容新增")
                $('#EditModal').modal("show");
            })

            $('[id="Btn_Not"]').on('click', function () {
                $('#EditModal').modal("hide");
            });

            $('[id="btnDelete"]').on('click', function () {
                var tid = $(this).attr('data-count');
                var titem = $('#' + tid).attr('data-item');
                if (confirm("確認要刪除此商品?") == true) {
                    $.post("@Url.Action("OrderDetailDelete", "Query")", { 'item': titem },
                        function (datas) {
                            alert(datas);
                            location.reload();
                        })
                }
            });

            $('#OrderEditTable').DataTable({
                paging: true,
                searching: false,
                ordering: true,
                lengthChange: true,
                language: {

                    lengthMenu: '<label>顯示</label><select class="custom-select custom-select-sm form-control form-control-sm">' + '<option value="10">10</option>' + '<option value="20">20</option>' + '<option value="30">30</option>' + '<option value="40">50</option>' + '<option value="50">100</option>' + '</select><label>筆</label>',

                    paginate: {
                        previous: "上一頁",
                        next: "下一頁",
                        first: "第一頁",
                        last: "最後一頁"
                    },
                    zeroRecords: "無資料",
                    info: "總共 _PAGES_ 頁，顯示第 _START_ 筆 到第 _END_ 筆。",
                    infoEmpty: "無紀錄",
                    infoFiltered: "",
                },
                pagingType: "full_numbers"
            });
        })

    </script>
}
